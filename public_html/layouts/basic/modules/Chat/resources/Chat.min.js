'use strict';

var classCallCheck = function (instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
};

var createClass = function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
}();

window.Chat_JS=function(){function Chat_Js(container){classCallCheck(this,Chat_Js),this.init(container),this.sendByEnter='true'!==app.getCookie('chat-notSendByEnter'),this.isSearchMode=!1,this.isHistoryMode=!1,this.isUnreadMode=!1,this.searchValue=null,this.isSearchParticipantsMode=!1,this.timerMessage=null,this.timerRoom=null,this.amountOfNewMessages=null,this.isSoundNotification='true'===app.getCookie('chat-isSoundNotification'),this.isModalWindow=!1;}return createClass(Chat_Js,[{key:'init',value:function init(container){this.container=container,this.messageContainer=this.container.find('.js-chat_content'),this.maxLengthMessage=this.messageContainer.data('maxLengthMessage'),this.searchInput=this.container.find('.js-search-message'),this.searchCancel=this.container.find('.js-search-cancel'),this.searchParticipantsInput=this.container.find('.js-search-participants'),this.searchParticipantsCancel=this.container.find('.js-search-participants-cancel'),this.participants=this.container.find('.js-participants-list .js-users');}},{key:'request',value:function request(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},_this=this,progress=!(1<arguments.length&&void 0!==arguments[1])||arguments[1],elementTo=2<arguments.length&&void 0!==arguments[2]?arguments[2]:this.messageContainer,aDeferred=$.Deferred(),progressIndicator=null;return progress&&(progressIndicator=this.progressShow(elementTo)),AppConnector.request($.extend({module:'Chat'},data)).done(function(data){aDeferred.resolve(data);}).fail(function(){_this.isModalWindow&&(Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_UNEXPECTED_ERROR'),type:'error',animation:'show'}),app.hideModalWindow(),_this.unregisterEvents(),Chat_Js.registerTrackingEvents());}).always(function(){progress&&progressIndicator.progressIndicator({mode:'hide'});}),aDeferred.promise()}},{key:'getLastMessageId',value:function getLastMessageId(){return this.messageContainer.find('.js-chat-item:last').data('mid')}},{key:'getRoomList',value:function getRoomList(){var reload=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];return ('undefined'==typeof this.roomList||reload)&&(this.roomList=this.container.find('.js-room-list')),this.roomList}},{key:'progressShow',value:function progressShow(elementTo){return $.progressIndicator({position:'html',blockInfo:{enabled:!0,elementToBlock:elementTo}})}},{key:'sendMessage',value:function sendMessage(inputMessage){var _this2=this,len=inputMessage.html().length;if(0!==len)if(len<this.maxLengthMessage){clearTimeout(this.timerMessage);var mid=null;this.isSearchMode||(mid=this.messageContainer.find('.js-chat-item:last').data('mid')),this.request({view:'Entries',mode:'send',roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId(),message:inputMessage.html(),mid:mid}).done(function(html){_this2.isSearchMode?(_this2.messageContainer.html(html),_this2.turnOffSearchMode(),_this2.registerLoadMore()):_this2.messageContainer.append(html),_this2.getMessage(!0),_this2.buildParticipantsFromMessage($('<div></div>').html(html)),_this2.scrollToBottom(!1);}),inputMessage.html('');}else Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_MESSAGE_TOO_LONG'),type:'error',animation:'show'});}},{key:'getAll',value:function getAll(){var _this3=this,reloadParticipants=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];clearTimeout(this.timerMessage),this.request({view:'Entries',mode:'get',roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){html&&(!_this3.isRoomActive()&&_this3.activateRoom(),reloadParticipants&&_this3.buildParticipantsFromInput($('<div></div>').html(html).find('.js-participants-data'),!0),_this3.messageContainer.html(html),_this3.scrollToBottom(),_this3.registerLoadMore()),_this3.getMessage(!0);});}},{key:'getMore',value:function getMore(btn){var _this4=this;clearTimeout(this.timerMessage),this.request({view:'Entries',mode:'getMore',lastId:btn.data('mid'),roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){html&&(btn.before(html),btn.remove(),_this4.registerLoadMore()),_this4.getMessage(!0);});}},{key:'searchMessage',value:function searchMessage(){var _this5=this,btn=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.isHistoryMode=!1,clearTimeout(this.timerMessage);var mid=null;null!==btn&&(mid=btn.data('mid')),this.request({view:'Entries',mode:'search',searchVal:this.searchInput.val(),mid:mid,roomType:this.getCurrentRoomType(),recordId:this.getCurrentRecordId()},!1).done(function(html){null===btn?_this5.messageContainer.html(html):(btn.before(html),btn.remove()),_this5.registerLoadMore(),null==mid&&_this5.scrollToBottom();});}},{key:'history',value:function history(){var _this6=this,btn=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,groupHistory=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'crm';this.isSearchMode=!1,this.isHistoryMode=!0,this.isUnreadMode=!1,clearTimeout(this.timerMessage);var mid=null;null!==btn&&(mid=btn.data('mid')),this.turnOffInputAndBtn(),this.request({view:'Entries',mode:'history',mid:mid,groupHistory:groupHistory},!0).done(function(html){null===btn?_this6.messageContainer.html(html):(btn.before(html),btn.remove()),_this6.registerLoadMore();});}},{key:'turnOffUnreadMode',value:function turnOffUnreadMode(){this.turnOnInputAndBtnInRoom(),this.isUnreadMode=!1;}},{key:'unread',value:function unread(){var _this7=this;clearTimeout(this.timerMessage),this.isSearchMode=!1,this.isHistoryMode=!1,this.isUnreadMode=!0,this.turnOffInputAndBtn(),this.request({view:'Entries',mode:'unread'},!0).done(function(html){_this7.messageContainer.html(html),_this7.participants.html(''),_this7.buildParticipantsFromMessage($('<div></div>').html(html));});}},{key:'turnOffInputAndBtn',value:function turnOffInputAndBtn(){var container=this.container;container.find('.js-users').addClass('hide'),container.find('.js-scrollbar').addClass('o-chat__scrollbar--history'),container.find('.js-footer-history-hide').removeClass('hide'),container.find('.js-footer-history').addClass('hide'),container.find('.js-room').removeClass('active o-chat__room'),this.messageContainer.removeClass('col-9'),this.messageContainer.addClass('col-12'),container.find('.js-chat-message').addClass('hide'),container.find('.js-btn-send').addClass('hide'),container.find('.js-input-group-search').addClass('hide');var footer=container.find('.js-chat-footer');this.isHistoryMode?(this.container.find('.js-chat-nav-history').removeClass('hide'),this.container.find('.js-footer-history-hide .js-breadcrumb-item').text(footer.data('lblHistory'))):this.isUnreadMode&&(this.container.find('.js-chat-nav-history').addClass('hide'),this.container.find('.js-footer-history-hide .js-breadcrumb-item').text(footer.data('lblUnread')));}},{key:'selectNavHistory',value:function selectNavHistory(){var _this8=this;this.container.find('.js-chat-nav-history .js-chat-link').each(function(index,element){$(element).on('click',function(){_this8.history(null,$(element).data('groupName'));});});}},{key:'turnOnInputAndBtnInRoom',value:function turnOnInputAndBtnInRoom(){var _this9=this;this.container.on('click','.js-room',function(){var container=_this9.container;container.find('.js-input-group-search').removeClass('hide'),container.find('.js-users').removeClass('hide'),container.find('.js-scrollbar').removeClass('o-chat__scrollbar--history');var messageContainer=container.find('.js-message-container');container.find('.js-footer-history-hide').addClass('hide'),container.find('.js-footer-history').removeClass('hide'),messageContainer.removeClass('col-12'),messageContainer.addClass('col-9'),container.find('.js-chat-nav-history').addClass('hide'),container.find('.js-chat-message').removeClass('hide'),container.find('.js-btn-send').removeClass('hide');});}},{key:'turnOffSearchMode',value:function turnOffSearchMode(){this.searchCancel.addClass('hide'),this.searchInput.val(''),this.isSearchMode=!1;}},{key:'turnOffSearchParticipantsMode',value:function turnOffSearchParticipantsMode(){this.searchParticipantsCancel.addClass('hide'),this.searchParticipantsInput.val(''),this.isSearchParticipantsMode=!1,this.participants.find('.js-item-user').each(function(index,element){$(element).removeClass('hide');});}},{key:'searchParticipants',value:function searchParticipants(){var searchVal=this.searchParticipantsInput.val().toLowerCase();this.participants.find('.js-item-user').each(function(index,element){var userName=$(element).find('.js-user-name').text().toLowerCase();$(element).toggleClass('hide',!(0<=userName.indexOf(searchVal)));}),this.container.find('.js-participants-list').scrollTop(0);}},{key:'createParticipantItem',value:function createParticipantItem(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},itemUser=this.container.find('.js-participants-list .js-temp-item-user').clone(!1,!1);return itemUser.removeClass('js-temp-item-user'),itemUser.removeClass('hide'),itemUser.find('.js-user-name').html(data.userName),itemUser.find('.js-role').html(data.role),itemUser.find('.js-message').html(data.message),itemUser.data('userId',data.userId),data.image&&(itemUser.find('.js-image .js-chat-image_icon').addClass('hide'),itemUser.find('.js-image .js-chat-image_src').removeClass('hide').attr('src',data.image)),itemUser}},{key:'getParticipantsFromMessages',value:function getParticipantsFromMessages(messageContainer){var participantsId=[];return messageContainer.find('.js-chat-item').each(function(index,element){var userId=$(element).data('userId');0>$.inArray(userId,participantsId)&&participantsId.push(userId);}),participantsId}},{key:'createParticipants',value:function createParticipants(){var participantsId=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];if(participantsId.length)for(var len=participantsId.length,i=0;i<len;++i){var userId=participantsId[i],lastMessage=this.messageContainer.find('.js-chat-item[data-user-id='+userId+']:last');lastMessage.length&&this.participants.append(this.createParticipantItem({userName:lastMessage.find('.js-author').data('userName'),role:lastMessage.find('.js-author').data('roleName'),message:lastMessage.find('.messages').html(),userId:userId,image:lastMessage.find('.js-author .js-image .js-chat-image_src').attr('src')}));}}},{key:'buildParticipantsFromMessage',value:function buildParticipantsFromMessage(messageContainer){if(!this.isSearchParticipantsMode){var currentParticipants=[];this.participants.find('.js-item-user').each(function(index,element){var userId=$(element).data('userId');currentParticipants.push(userId);var lastMessage=messageContainer.find('.js-chat-item[data-user-id='+userId+']:last');lastMessage.length&&$(element).find('.js-message').html(lastMessage.find('.js-message').html());}),this.createParticipants($(this.getParticipantsFromMessages(messageContainer)).not(currentParticipants).get());}}},{key:'buildParticipantsFromInput',value:function buildParticipantsFromInput(element){var reload=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1];if(!this.isSearchParticipantsMode&&(reload&&this.participants.html(''),element.length))for(var users=JSON.parse(element.val()),len=users.length,i=0;i<len;++i)this.participants.append(this.createParticipantItem({userName:users[i].user_name,role:users[i].role_name,message:users[i].message,userId:users[i].user_id,image:users[i].image}));}},{key:'isRoomActive',value:function isRoomActive(){return 0===this.container.find('.js-container-chat').length||!this.container.find('.js-container-chat').hasClass('hide')}},{key:'getCurrentRoomType',value:function getCurrentRoomType(){return this.messageContainer.data('currentRoomType')}},{key:'getCurrentRecordId',value:function getCurrentRecordId(){return this.messageContainer.data('currentRecordId')}},{key:'isViewForRecord',value:function isViewForRecord(){return this.messageContainer.data('viewForRecord')}},{key:'getMessageTimer',value:function getMessageTimer(){return this.messageContainer.data('messageTimer')}},{key:'getRoomTimer',value:function getRoomTimer(){return this.messageContainer.data('roomTimer')}},{key:'activateRoom',value:function activateRoom(){this.container.find('.js-container-button').addClass('hide'),this.container.find('.js-container-chat').removeClass('hide');}},{key:'scrollToBottom',value:function scrollToBottom(){var scrollToTop=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],chatContent=this.messageContainer.closest('.js-chat-main-content');scrollToTop&&chatContent.scrollTop(0),chatContent.length&&chatContent.animate({scrollTop:chatContent[0].scrollHeight},300);}},{key:'soundNotification',value:function soundNotification(){this.isSoundNotification&&app.playSound('CHAT');}},{key:'selectRoom',value:function selectRoom(roomType,recordId){var roomList=this.getRoomList();roomList.find('.js-room').each(function(index,element){$(element).removeClass('active o-chat__room');});var itemRoom=roomList.find('.js-room-type[data-room-type='+roomType+'] .js-room[data-record-id='+recordId+']');itemRoom.addClass('active o-chat__room'),this.getRoomName(itemRoom,roomType),itemRoom.find('.js-room-cnt').html(''),this.messageContainer.data('currentRoomType',roomType),this.messageContainer.data('currentRecordId',recordId);}},{key:'createRoomItem',value:function createRoomItem(){var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},favorite=!!(1<arguments.length&&void 0!==arguments[1])&&arguments[1],roomType=2<arguments.length&&void 0!==arguments[2]?arguments[2]:'global',itemRoom=this.container.find('.js-room-list .js-temp-item-room').clone(!1,!1);return itemRoom.removeClass('js-temp-item-room').removeClass('hide'),itemRoom.addClass('d-flex'),itemRoom.find('.js-room-name').html(data.name),itemRoom.attr('title',data.name),'crm'===roomType&&itemRoom.find('.js-link').removeClass('hide').attr('href','index.php?module='+data.moduleName+'&view=Detail&record='+data.recordid),0==data.cnt_new_message?itemRoom.find('.js-room-cnt').html(''):itemRoom.find('.js-room-cnt').html(data.cnt_new_message),favorite&&itemRoom.find('.js-remove-favorites').removeClass('hide'),itemRoom.attr('data-record-id',data.recordid),itemRoom}},{key:'getRoomName',value:function getRoomName(data,roomType){var container=this.container,containerFooter=container.find('.js-chat-footer');container.find('.js-group-name').each(function(){var element=$(this);element.data('group')==roomType&&containerFooter.find('.js-footer-group-name').text(element.text());}),containerFooter.find('.js-footer-room-name').text(data.find('.js-room-name').text());}},{key:'reloadRoomsDetail',value:function reloadRoomsDetail(data){var currentRoomType=this.getCurrentRoomType(),currentRecordId=this.getCurrentRecordId(),roomList=this.getRoomList(),cnt=0;for(var key in this.selectRoom(data.currentRoom.roomType,data.currentRoom.recordId),data.roomList){var roomTypeList=roomList.find('.js-room-type[data-room-type="'+key+'"]').not('.js-hide-group');for(var idx in roomTypeList.html(''),data.roomList[key]){var newMessage=data.roomList[key][idx].cnt_new_message;null!==newMessage&&(cnt+=newMessage);var itemRoom=this.createRoomItem(data.roomList[key][idx],roomTypeList.data('favoriteRemoveBtn'),key);key===currentRoomType&&data.roomList[key][idx].recordid===currentRecordId&&itemRoom.addClass('active o-chat__room'),roomTypeList.append(itemRoom);}}null!==this.amountOfNewMessages&&cnt>this.amountOfNewMessages&&this.soundNotification(),this.amountOfNewMessages=cnt,this.registerSwitchRoom(),this.registerButtonFavoritesInModal();}},{key:'getMessage',value:function getMessage(){var _this10=this,timer=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];timer&&clearTimeout(this.timerMessage),this.timerMessage=setTimeout(function(){_this10.request({view:'Entries',mode:'get',lastId:_this10.getLastMessageId(),roomType:_this10.getCurrentRoomType(),recordId:_this10.getCurrentRecordId(),viewForRecord:_this10.isViewForRecord()},!1).done(function(html){html&&(!_this10.isRoomActive()&&_this10.activateRoom(),_this10.messageContainer.append(html),_this10.buildParticipantsFromMessage($('<div></div>').html(html)),_this10.scrollToBottom(!1)),timer&&_this10.getMessage(!0);});},this.getMessageTimer());}},{key:'getRoomsDetail',value:function getRoomsDetail(){var _this11=this,timer=!!(0<arguments.length&&void 0!==arguments[0])&&arguments[0];timer&&clearTimeout(this.timerRoom),this.timerRoom=setTimeout(function(){_this11.request({action:'Room',mode:'getAll'},!1).done(function(data){_this11.reloadRoomsDetail(data.result),timer&&_this11.getRoomsDetail(!0);});},this.getRoomTimer());}},{key:'registerSendEvent',value:function registerSendEvent(){var _this12=this,inputMessage=this.container.find('.js-chat-message');inputMessage.on('keydown',function(e){_this12.sendByEnter&&(e.shiftKey||13!==e.keyCode||(e.preventDefault(),_this12.sendMessage(inputMessage)));}),this.container.find('.js-btn-send').on('click',function(){_this12.sendMessage(inputMessage);});}},{key:'registerSwitchRoom',value:function registerSwitchRoom(){var _this13=this;this.container.find('.js-room-list .js-room').off('click').on('click',function(e){clearTimeout(_this13.timerMessage),clearTimeout(_this13.timerRoom);var element=$(e.currentTarget),recordId=element.data('recordId'),roomType=element.closest('.js-room-type').data('roomType');_this13.request({view:'Entries',mode:'get',roomType:roomType,recordId:recordId},!0,_this13.container).done(function(html){_this13.turnOffSearchParticipantsMode(),_this13.selectRoom(roomType,recordId),_this13.buildParticipantsFromInput($('<div></div>').html(html).find('.js-participants-data'),!0),_this13.messageContainer.html(html),_this13.getMessage(!0),_this13.getRoomsDetail(!0),_this13.scrollToBottom(),_this13.registerLoadMore(),_this13.turnOffSearchMode(),_this13.isHistoryMode=!1,_this13.turnOffUnreadMode();});});}},{key:'registerButtonFavorites',value:function registerButtonFavorites(){var _this14=this,btnRemove=this.container.find('.js-remove-from-favorites'),btnAdd=this.container.find('.js-add-from-favorites');btnRemove.off('click').on('click',function(){btnRemove.toggleClass('hide'),btnAdd.toggleClass('hide'),_this14.request({action:'Room',mode:'removeFromFavorites',roomType:_this14.getCurrentRoomType(),recordId:_this14.getCurrentRecordId()});}),btnAdd.off('click').on('click',function(){btnRemove.toggleClass('hide'),btnAdd.toggleClass('hide'),_this14.request({action:'Room',mode:'addToFavorites',roomType:_this14.getCurrentRoomType(),recordId:_this14.getCurrentRecordId()});});}},{key:'registerButtonFavoritesInModal',value:function registerButtonFavoritesInModal(){var _this15=this;this.getRoomList().find('.js-room .js-remove-favorites').off('click').on('click',function(e){clearTimeout(_this15.timerMessage),e.stopPropagation();var btn=$(e.currentTarget),item=btn.closest('.js-room'),roomType=btn.closest('.js-room-type').data('roomType');_this15.request({action:'Room',mode:'removeFromFavorites',roomType:roomType,recordId:item.data('recordId')}).done(function(){if('group'===roomType){var listGroup=_this15.getRoomList().find('.js-hide-group');item.detach(),item.find('.js-remove-favorites').addClass('hide'),item.find('.js-add-favorites').removeClass('hide'),listGroup.append(item),_this15.container.find('.js-btn-more-remove').removeClass('hide'),_this15.container.find('.js-btn-more').addClass('hide'),listGroup.removeClass('hide');}else item.remove();_this15.getRoomsDetail(!0);});}),this.getRoomList().find('.js-room .js-add-favorites').off('click').on('click',function(e){e.stopPropagation();var btn=$(e.currentTarget),item=btn.closest('.js-room'),roomType=btn.closest('.js-room-type').data('roomType');_this15.request({action:'Room',mode:'addToFavorites',roomType:roomType,recordId:item.data('recordId')}).done(function(){if('group'===roomType){var listGroup=_this15.getRoomList().find('.js-room-type[data-room-type=group]').not('.js-hide-group');item.detach(),item.find('.js-remove-favorites').removeClass('hide'),item.find('.js-add-favorites').addClass('hide'),listGroup.append(item),0===_this15.getRoomList().find('.js-hide-group .js-room').length&&_this15.container.find('.js-btn-more-remove').addClass('hide');}else item.remove();});});}},{key:'registerButtonMoreInRoom',value:function registerButtonMoreInRoom(){var btnMore=this.container.find('.js-btn-more'),btnMoreRemove=this.container.find('.js-btn-more-remove'),listHideGroup=this.container.find('.js-hide-group');btnMore.on('click',function(){listHideGroup.toggleClass('hide'),btnMore.toggleClass('hide'),btnMoreRemove.toggleClass('hide');}),btnMoreRemove.on('click',function(){listHideGroup.toggleClass('hide'),btnMore.toggleClass('hide'),btnMoreRemove.toggleClass('hide');});}},{key:'registerLoadMore',value:function registerLoadMore(){var _this16=this;this.messageContainer.find('.js-load-more').off('click').on('click',function(e){var btn=$(e.currentTarget);_this16.isSearchMode?_this16.searchMessage(btn):_this16.isHistoryMode?_this16.history(btn,_this16.container.find('.js-chat-nav-history .js-chat-link .active').closest('.js-chat-link').data('groupName')):_this16.getMore(btn);});}},{key:'registerSearchMessage',value:function registerSearchMessage(){var _this17=this;this.searchInput.off('keydown').on('keydown',function(e){13===e.keyCode&&(e.preventDefault(),''===_this17.searchInput.val()?(_this17.searchCancel.addClass('hide'),_this17.isSearchMode=!1):(_this17.isSearchMode=!0,_this17.searchCancel.removeClass('hide'),_this17.searchMessage()));}),this.container.find('.js-icon-search-message').on('click',function(e){e.preventDefault(),''===_this17.searchInput.val()?(_this17.searchCancel.addClass('hide'),_this17.isSearchMode=!1):(_this17.isSearchMode=!0,_this17.searchCancel.removeClass('hide'),_this17.searchMessage());}),this.searchCancel.off('click').on('click',function(e){e.preventDefault(),_this17.turnOffSearchMode(),_this17.getAll(!1);});}},{key:'registerSearchParticipants',value:function registerSearchParticipants(){var _this18=this;this.searchParticipantsInput.off('keyup').on('keyup',function(){var len=_this18.searchParticipantsInput.val().length;1<len?(_this18.isSearchParticipantsMode=!0,_this18.searchParticipantsCancel.removeClass('hide')):0===len&&_this18.turnOffSearchParticipantsMode(),_this18.searchParticipants();}),this.searchParticipantsCancel.off('click').on('click',function(){_this18.turnOffSearchParticipantsMode(),_this18.searchParticipants();});}},{key:'registerButtonHistory',value:function registerButtonHistory(){var _this19=this;this.container.find('.js-btn-history').off('click').on('click',function(){_this19.history();});}},{key:'registerButtonSettings',value:function registerButtonSettings(){this.container.find('.js-btn-settings').off('click').on('click',function(){});}},{key:'registerButtonDesktopNotification',value:function registerButtonDesktopNotification(){var _this20=this,btnDesktop=this.container.find('.js-btn-desktop-notification'),iconOn=btnDesktop.data('iconOn'),iconOff=btnDesktop.data('iconOff');Chat_Js.isDesktopNotification()&&!Chat_Js.checkDesktopPermission()?(app.setCookie('chat-isDesktopNotification',!1,365),btnDesktop.find('.js-icon').removeClass(iconOn).addClass(iconOff)):Chat_Js.isDesktopNotification()&&btnDesktop.find('.js-icon').removeClass(iconOff).addClass(iconOn),btnDesktop.off('click').on('click',function(){btnDesktop.find('.js-icon').toggleClass(iconOn+' '+iconOff),btnDesktop.find('.js-icon').hasClass(iconOn)?!Chat_Js.checkDesktopPermission()&&(PNotify.modules.Desktop.permission(),setTimeout(function(){Chat_Js.checkDesktopPermission()?app.setCookie('chat-isDesktopNotification',!0,365):(app.setCookie('chat-isDesktopNotification',!1,365),btnDesktop.find('.js-icon').removeClass(iconOn).addClass(iconOff),_this20.desktopNotificationShouldReload=!0,Vtiger_Helper_Js.showPnotify({text:app.vtranslate('JS_NO_DESKTOP_PERMISSION'),type:'info',animation:'show'}));},2e3)):app.setCookie('chat-isDesktopNotification',!1,365);});}},{key:'registerButtonBell',value:function registerButtonBell(){var _this21=this,btnBell=this.container.find('.js-btn-bell');btnBell.off('click').on('click',function(){var icon=btnBell.find('.js-icon');icon.toggleClass(btnBell.data('iconOn')).toggleClass(btnBell.data('iconOff')),_this21.isSoundNotification=icon.hasClass(btnBell.data('iconOn')),app.setCookie('chat-isSoundNotification',_this21.isSoundNotification,365);});}},{key:'registerButtonUnread',value:function registerButtonUnread(){var _this22=this;this.container.find('.js-btn-unread').on('click',function(){_this22.unread();});}},{key:'registerButtonToggleEnter',value:function registerButtonToggleEnter(){var _this23=this,btnEnter=this.container.find('.js-btn-enter');btnEnter.on('click',function(){_this23.sendByEnter=!_this23.sendByEnter,app.setCookie('chat-notSendByEnter',!_this23.sendByEnter,365);var icon=btnEnter.find('.js-icon');icon.toggleClass(btnEnter.data('iconOn'),_this23.sendByEnter).toggleClass(btnEnter.data('iconOff'),!_this23.sendByEnter);});}},{key:'registerCloseModal',value:function registerCloseModal(){var _this24=this;this.container.find('.close[data-dismiss="modal"]').on('click',function(){_this24.unregisterEvents(),Chat_Js.registerTrackingEvents();});}},{key:'registerBaseEvents',value:function registerBaseEvents(){var _this25=this;this.registerSendEvent(),this.registerLoadMore(),this.getMessage(!0),this.registerButtonFavorites(),this.registerSearchMessage(),this.registerSearchParticipants(),new App.Fields.Text.Completions(this.container.find('.js-completions')),setTimeout(function(){_this25.scrollToBottom();},100);}},{key:'registerModalEvents',value:function registerModalEvents(){this.getRoomList(!0),this.getRoomsDetail(!0),this.registerBaseEvents(),this.registerSwitchRoom(),this.registerButtonHistory(),this.registerButtonSettings(),this.registerButtonBell(),this.registerButtonUnread(),this.registerButtonFavoritesInModal(),this.registerButtonMoreInRoom(),this.registerButtonDesktopNotification(),this.registerButtonToggleEnter(),this.registerCloseModal(),this.turnOnInputAndBtnInRoom(),this.selectNavHistory(),Chat_Js.unregisterTrackingEvents(),this.isModalWindow=!0;}},{key:'unregisterEvents',value:function unregisterEvents(){clearTimeout(this.timerMessage),clearTimeout(this.timerRoom);}}],[{key:'getInstance',value:function getInstance(container){var typeInstance=1<arguments.length&&void 0!==arguments[1]?arguments[1]:'modal';return 'undefined'==typeof Chat_Js.instance&&(Chat_Js.instance={}),'undefined'==typeof Chat_Js.instance[typeInstance]?Chat_Js.instance[typeInstance]=new Chat_Js(container):Chat_Js.instance[typeInstance].init(container),Chat_Js.instance[typeInstance]}},{key:'getHeaderChatButton',value:function getHeaderChatButton(){return 'undefined'==typeof Chat_Js.headerChatButton&&(window.location===window.top.location?Chat_Js.headerChatButton=$('.js-header-chat-button'):Chat_Js.headerChatButton=window.top.$('.js-header-chat-button')),Chat_Js.headerChatButton}},{key:'getRefreshTimeGlobal',value:function getRefreshTimeGlobal(){return 'undefined'==typeof Chat_Js.refreshTimerGlobal&&(Chat_Js.refreshTimeGlobal=Chat_Js.getHeaderChatButton().data('refreshTimeGlobal')),Chat_Js.refreshTimeGlobal}},{key:'registerTrackingEvents',value:function registerTrackingEvents(){var headerChatButton=Chat_Js.getHeaderChatButton(),showNumberOfNewMessages=headerChatButton.data('showNumberOfNewMessages'),lblChatNewMessage=headerChatButton.data('lblChatNewMessage'),lblChat=headerChatButton.data('lblChat');return headerChatButton.data('userSwitched')?void headerChatButton.on('click',function(){Vtiger_Helper_Js.showPnotify({text:headerChatButton.data('lblChatUserSwitched'),type:'error',animation:'show'});}):void(!Chat_Js.getRefreshTimeGlobal()||(Chat_Js.timerGlobal=setTimeout(function(){AppConnector.request({module:'Chat',action:'Room',mode:'tracking'}).done(function(data){var badge=headerChatButton.find('.js-badge');if(0<data.result?(headerChatButton.toggleClass('btn-light').toggleClass('btn-danger'),showNumberOfNewMessages&&(badge.removeClass('hide'),badge.html(data.result))):headerChatButton.hasClass('btn-danger')&&(headerChatButton.removeClass('btn-danger').addClass('btn-light'),showNumberOfNewMessages&&(badge.addClass('hide'),badge.html(''))),data.result>Chat_Js.amountOfNewMessages&&('true'===app.getCookie('chat-isSoundNotification')&&app.playSound('CHAT'),Chat_Js.desktopPermission())){var message=lblChatNewMessage;showNumberOfNewMessages&&(message+=' '+data.result),app.showNotify({text:message,title:lblChat,type:'success'},!0);}Chat_Js.amountOfNewMessages=data.result,Chat_Js.registerTrackingEvents();});},Chat_Js.getRefreshTimeGlobal())))}},{key:'unregisterTrackingEvents',value:function unregisterTrackingEvents(){clearTimeout(Chat_Js.timerGlobal);var headerChatButton=Chat_Js.getHeaderChatButton(),badge=headerChatButton.find('.js-badge');badge.addClass('hide'),badge.html(''),headerChatButton.removeClass('btn-danger').addClass('btn-light');}},{key:'desktopPermission',value:function desktopPermission(){return !!Chat_Js.isDesktopNotification()&&(!!Chat_Js.checkDesktopPermission()||(app.setCookie('chat-isDesktopNotification',!1,365),!1))}},{key:'isDesktopNotification',value:function isDesktopNotification(){return 'true'===app.getCookie('chat-isDesktopNotification')}},{key:'checkDesktopPermission',value:function checkDesktopPermission(){return 0===PNotify.modules.Desktop.checkPermission()}}]),Chat_Js}();
//# sourceMappingURL=Chat.min.js.map
